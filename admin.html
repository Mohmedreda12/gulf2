<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>لوحة الإدارة</title>
  <style>
    body{margin:0;background:#0b1220;color:#e5e7eb;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .container{width:min(1000px,92vw);margin:auto}
    header{padding:1rem 0;border-bottom:1px solid rgba(255,255,255,.08);background:#101827}
    .card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:.8rem;padding:1rem;margin:1rem 0}
    label{display:block;margin:.35rem 0 .2rem}
    input,select,textarea{width:100%;padding:.6rem;border-radius:.6rem;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.06);color:#fff}
    input[type=file]{padding:.4rem}
    textarea{min-height:90px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:.8rem}
    @media (max-width:800px){.row{grid-template-columns:1fr}}
    .btn{border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.08);padding:.6rem .9rem;border-radius:.6rem;color:#fff;font-weight:800;cursor:pointer}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:.8rem}
    @media (max-width:900px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:640px){.grid{grid-template-columns:1fr}}
    .item{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08);border-radius:.6rem;padding:.6rem}
    .muted{color:#a3b2c5}
    .login{max-width:420px;margin:2rem auto}
    .preview{width:100%;max-height:260px;object-fit:cover;border-radius:.6rem;border:1px solid rgba(255,255,255,.12);background:#0f172a}
  </style>
</head>
<body>

<header>
  <div class="container">
    <h1 style="margin:.2rem 0">لوحة الإدارة</h1>
    <div class="muted">تجريبي — تخزين سحابي (Supabase)</div>
  </div>
</header>

<main class="container">
  <!-- تسجيل الدخول -->
  <section id="login" class="card login">
    <label>البريد الإلكتروني</label><input id="email" type="text" placeholder="admin" />
    <label>كلمة المرور</label><input id="pw" type="password" placeholder="••••••••" />
    <button class="btn" id="doLogin" style="margin-top:.6rem">دخول</button>
    <div id="msg" class="muted" style="margin-top:.4rem"></div>
  </section>

  <!-- لوحة التحكم -->
  <section id="panel" style="display:none">
    <div class="card">
      <div class="row">
        <div>
          <label>القسم</label>
          <select id="cat">
            <option value="fr">ملابس مقاومة للحريق (FR)</option>
            <option value="med_schools">القطاع الطبي + المدارس</option>
            <option value="sec_hosp">الأمن + المطاعم والضيافة</option>
          </select>
        </div>
        <div>
          <label>اختر الصورة من جهازك</label>
          <input id="file" type="file" accept="image/*" />
          <img id="preview" class="preview" alt="معاينة الصورة" style="margin-top:.5rem;display:none" />
          <div class="muted" style="font-size:.85rem;margin-top:.3rem">
            سيتم تصغير الصورة تلقائيًا إلى أقصى عرض 1200px قبل الرفع.
          </div>
          <div style="margin-top:.4rem;display:flex;gap:.5rem">
            <button id="clearImg" class="btn" type="button">مسح الصورة</button>
            <a class="btn" href="products.html" target="_blank">فتح صفحة المنتجات</a>
          </div>
        </div>
      </div>

      <div class="row" style="margin-top:.6rem">
        <div><label>العنوان</label><input id="title_ar" placeholder="اسم المنتج بالعربي" /></div>
        <div><label>الوصف</label><textarea id="desc_ar" placeholder="وصف مختصر…"></textarea></div>
      </div>

      <div style="margin-top:.8rem">
        <button id="add" class="btn">إضافة المنتج</button>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;gap:.6rem;align-items:center;flex-wrap:wrap">
        <strong>المنتجات الحالية</strong>
        <select id="listCat">
          <option value="fr">FR</option>
          <option value="med_schools">Medical + Schools</option>
          <option value="sec_hosp">Security + Hospitality</option>
        </select>
        <button id="refresh" class="btn">تحديث</button>
      </div>
      <div id="list" class="grid" style="margin-top:.8rem"></div>
    </div>
  </section>
</main>

<!-- مكتبة Supabase -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<script>
/* ===== Supabase config ===== */
const SUPABASE_URL = "https://nwymwhwwbgadcjyrrvyc.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im53eW13aHd3YmdhZGNqeXJydnljIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzODkzMjYsImV4cCI6MjA3Mzk2NTMyNn0.K6vOyGus_mbmwn-BPlS5BVKzIzbWc7r_m_c4MsynPRA";
const BUCKET = "images";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ===== Login (مؤقت) ===== */
const ADMIN_EMAIL='admin';
const ADMIN_PASS='gulf12';
document.getElementById('doLogin').onclick = () => {
  const email = document.getElementById('email').value.trim().toLowerCase();
  const pw    = document.getElementById('pw').value;
  const ok = (email===ADMIN_EMAIL && pw===ADMIN_PASS);
  document.getElementById('msg').textContent = ok ? 'تم الدخول' : 'بيانات الدخول غير صحيحة';
  if(ok){
    document.getElementById('login').style.display='none';
    document.getElementById('panel').style.display='block';
    renderList();
  }
};

/* ===== Preview + compress ===== */
const fileInput = document.getElementById('file');
const preview   = document.getElementById('preview');
const clearBtn  = document.getElementById('clearImg');

let selectedFile = null;
let compressedBlob = null;

fileInput.addEventListener('change', async (e)=>{
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  selectedFile = f;
  preview.src = URL.createObjectURL(f);
  preview.style.display = 'block';
  const dataUrl = await fileToCompressedDataURL(f, 1200, 0.85);
  compressedBlob = dataURLtoBlob(dataUrl);
});
clearBtn.addEventListener('click', ()=>{
  fileInput.value=''; selectedFile=null; compressedBlob=null;
  preview.src=''; preview.style.display='none';
});

async function fileToCompressedDataURL(file, maxW=1200, quality=0.85){
  const dataURL = await new Promise((resolve,reject)=>{
    const fr=new FileReader(); fr.onload=()=>resolve(fr.result); fr.onerror=reject; fr.readAsDataURL(file);
  });
  const img = await new Promise((res,rej)=>{
    const i=new Image(); i.onload=()=>res(i); i.onerror=rej; i.src=dataURL;
  });
  const scale = Math.min(1, maxW / img.width);
  const w = Math.round(img.width * scale), h = Math.round(img.height * scale);
  const canvas = document.createElement('canvas'); canvas.width=w; canvas.height=h;
  canvas.getContext('2d').drawImage(img, 0, 0, w, h);
  return canvas.toDataURL('image/jpeg', quality);
}

function dataURLtoBlob(dataURL){
  const [head, body] = dataURL.split(',');
  const mime = head.match(/:(.*?);/)[1];
  const bin  = atob(body); const len = bin.length; const u8=new Uint8Array(len);
  for(let i=0;i<len;i++) u8[i]=bin.charCodeAt(i);
  return new Blob([u8], { type: mime });
}

/* === helper: إحضار الرابط العام للصورة من التخزين === */
function getPublicUrl(path){
  const { data } = sb.storage.from(BUCKET).getPublicUrl(path);
  return data.publicUrl;
}

/* ===== Upload to storage ===== */
async function uploadImage(){
  const file = compressedBlob || selectedFile;
  if (!file) { alert('اختر صورة من جهازك'); return null; }

  // لو هنرفع النسخة المضغوطة نجبر الامتداد jpg
  let ext = (file.type && file.type.split('/')[1]) || 'jpg';
  if (compressedBlob) ext = 'jpg';

  // ✅ السطر الصحيح باستخدام backticks والنص "public/"
  const path = `public/${Date.now()}_${Math.random().toString(36).slice(2)}.${ext}`;

  const { data, error } = await sb.storage.from(BUCKET).upload(path, file, { upsert: false });
  if (error) { alert('خطأ في رفع الصورة: ' + error.message); return null; }
  return data.path;
}

/* ===== Insert product ===== */
document.getElementById('add').onclick = async ()=>{
  const cat   = document.getElementById('cat').value;
  const title = document.getElementById('title_ar').value.trim();
  const desc  = document.getElementById('desc_ar').value.trim();
  if(!title){ alert('أدخل عنوان المنتج'); return; }
  if(!selectedFile && !compressedBlob){ alert('اختر صورة من جهازك'); return; }

  const image_path = await uploadImage();
  if(!image_path) return;                      // ✅ لو مفيش صورة نوقف
  const image_url  = getPublicUrl(image_path); // ✅ توليد رابط عام

  const { error } = await sb.from('products').insert([{
    category: cat,
    title: title,
    description: desc,
    image_url,
    image_path,
    is_published: true
  }]);                                         // ممكن تضيف .select() لو محتاج data
  if(error){ alert('خطأ في حفظ المنتج: ' + error.message); return; }

  // تنظيف
  document.getElementById('title_ar').value='';
  document.getElementById('desc_ar').value='';
  fileInput.value=''; selectedFile=null; compressedBlob=null;
  preview.src=''; preview.style.display='none';

  await renderList();
  alert('تمت إضافة المنتج ✅');
};

/* ===== List + delete ===== */
document.getElementById('refresh').onclick = renderList;
document.getElementById('listCat').onchange = renderList;

async function renderList(){
  const cat  = document.getElementById('listCat').value;
  const wrap = document.getElementById('list');
  wrap.innerHTML = '...';

  const { data, error } = await sb.from('products')
    .select('*')
    .eq('category', cat)
    .order('created_at', { ascending:false });

  if(error){ wrap.innerHTML = '<div class="muted">خطأ في الجلب</div>'; return; }
  if(!data || !data.length){ wrap.innerHTML = '<div class="muted">لا توجد منتجات بعد</div>'; return; }

  wrap.innerHTML = data.map((p,i)=>`
    <div class="item">
      <div class="muted" style="font-size:.85rem">${cat.toUpperCase()} #${i+1}</div>
      <img src="${p.image_url}" alt="" style="width:100%;max-height:180px;object-fit:cover;border-radius:.4rem;margin:.3rem 0">
      <h4 style="margin:.2rem 0">${p.title || '(بدون اسم)'}</h4>
      <div class="muted" style="margin:.2rem 0">${p.description||''}</div>
      <div style="margin-top:.5rem;display:flex;gap:.5rem;flex-wrap:wrap">
        <button class="btn" data-id="${p.id}" data-path="${p.image_path}">حذف</button>
      </div>
    </div>
  `).join('');

wrap.querySelectorAll('button[data-id]').forEach(btn => {
  btn.onclick = async () => {
    if (!confirm('مسح المنتج والصورة؟')) return;

    const id   = btn.getAttribute('data-id');   // <-- بدون +
    const path = btn.getAttribute('data-path');

    // امسح الصورة من الستوريج أولاً
    const { error: stErr } = await sb.storage.from(BUCKET).remove([path]);
    if (stErr) { alert('خطأ في مسح الصورة: ' + stErr.message); return; }

    // بعدين امسح السجل من الجدول
    const { error: delErr } = await sb.from('products').delete().eq('id', id);
    if (delErr) { alert('خطأ في مسح السجل: ' + delErr.message); return; }

    await renderList();
    alert('تم المسح ✅');
  };
});

}
</script>

</body>
</html>
